#!/usr/bin/env python

import json
from argparse import ArgumentParser

# configure argument parser
parser = ArgumentParser()
parser.add_argument('nb_file', help='notebook file (.ipynb) to convert')
parser.add_argument('--tasks', '-t',
                    action='store_true', default=True, help='keep tasks and remove solutions (default)')
parser.add_argument('--solutions', '-s',
                    action='store_true', default=False, help='keep solutions and remove tasks')

args = parser.parse_args()

# read file
with open(args.nb_file, 'r', encoding='utf-8') as file:
    data = json.load(file)

# convert cells
if args.solutions:
    remove = '##SOLUTION', '##TASK'
else:
    remove = '##TASK', '##SOLUTION'

for cell in data['cells']:
    if cell['cell_type'] != 'code':
        continue

    i = 0
    rem = False

    while i < len(cell['source']):
        line = cell['source'][i].strip()

        if line == remove[0]:
            del cell['source'][i]
            rem = False

        elif line == remove[1]:
            del cell['source'][i]
            rem = True

        elif line == '##END':
            del cell['source'][i]
            rem = False

        elif rem:
            del cell['source'][i]

        else:
            i += 1

# write to stdout
print(json.dumps(data, indent=4))
